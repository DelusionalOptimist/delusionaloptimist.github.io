<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Userspace security</title><meta name=description content><meta name=keywords content="blog,security,linux,ptrace,seccomp,LD_PRELOAD,cloud"><meta property="og:url" content="https://delusionaloptimist.github.io/posts/userspace-security/"><meta property="og:type" content="website"><meta property="og:title" content="Userspace security"><meta property="og:description" content><meta property="og:image" content="https://delusionaloptimist.github.io/rudraksh-pareek.jpg"><meta property="og:image:secure_url" content="https://delusionaloptimist.github.io/rudraksh-pareek.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Userspace security"><meta name=twitter:description content><meta property="twitter:domain" content="https://delusionaloptimist.github.io/posts/userspace-security/"><meta property="twitter:url" content="https://delusionaloptimist.github.io/posts/userspace-security/"><meta name=twitter:image content="https://delusionaloptimist.github.io/rudraksh-pareek.jpg"><link rel=canonical href=https://delusionaloptimist.github.io/posts/userspace-security/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://delusionaloptimist.github.io/><img src=https://delusionaloptimist.github.io//rudraksh-pareek.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://delusionaloptimist.github.io/>Rudraksh Pareek (DelusionalOptimist)</a></div><div class=nav-links><div class=nav-link><a href=https://delusionaloptimist.github.io/>Home</a></div><div class=nav-link><a href=https://delusionaloptimist.github.io/about>About</a></div><div class=nav-link><a href=https://drive.google.com/file/d/1IS6nEOysnhUEo24BhjpgezTzi0Fz6xCP/view>Resume</a></div><div class=nav-link><a href=https://delusionaloptimist.github.io/posts/>Posts</a></div><div class=nav-link><a href=https://delusionaloptimist.github.io/talks/>Talks</a></div><div class=nav-link><a href=https://github.com/DelusionalOptimist><span data-feather=github></span></a></div><div class=nav-link><a href=https://delusionaloptimist.github.io/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://delusionaloptimist.github.io/>Home</a></li><li class=nav-item><a href=https://delusionaloptimist.github.io/about>About</a></li><li class=nav-item><a href=https://drive.google.com/file/d/1IS6nEOysnhUEo24BhjpgezTzi0Fz6xCP/view>Resume</a></li><li class=nav-item><a href=https://delusionaloptimist.github.io/posts/>Posts</a></li><li class=nav-item><a href=https://delusionaloptimist.github.io/talks/>Talks</a></li><li class=nav-item><a href=https://github.com/DelusionalOptimist><span data-feather=github></span></a></li><li class=nav-item><a href=https://delusionaloptimist.github.io/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Userspace security</h1><small role=doc-subtitle></small><p class=post-date>September 16, 2023</p><ul class=post-tags><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/security>security</a></li><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/linux>linux</a></li><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/ptrace>ptrace</a></li><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/seccomp>seccomp</a></li><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/ld_preload>LD_PRELOAD</a></li><li class=post-tag><a href=https://delusionaloptimist.github.io/tags/cloud>cloud</a></li></ul></div><div class=post-content><p><h1 id=introduction>Introduction</h1><p>There are several mechanisms for protecting your workloads at runtime. However, what to use and how effective will it be is subject to the workload&rsquo;s environment.</p><p>Many runtime seucrity tools use eBPF for enforcing runtime security. It is a powerful mechanism which provides deep observability by directly instrumenting the OS kernel. However, a side effect of this is the need of privileged access to workloads&rsquo; underlying infrastructure.</p><p>It is also noteworthy that cloud platforms recently have started to abstract away infrastructure, hiding many configuration knobs, so that users can have a more smoother and secure experience. An example is AWS Fargate. Available to use with ECS and EKS clusters, it abstracts away the underlying EC2 instances by adding it&rsquo;s own agent in the usual container data plane and further isolating by running single workload per instance. It also restricts certain primitives as an attempt to keep the enviornment secure.</p><p>So, the ask is to create a security tool which can work without much coupling with the underlying hosts.</p><h1 id=ptrace>ptrace</h1><p>ptrace is a syscall in *nix operating systems. It allows a process (tracer) to inspect and manipulate the state of another process (tracee).</p><p>But ptrace has existed for a long time. It is very likely that you&rsquo;ve used a tool based on ptrace. Debuggers like gdb and delve use ptrace to insert breakpoints into your program, strace uses ptrace to trace syscalls made by an application and so on.</p><h3 id=how-does-ptrace-work>How does ptrace work</h3><p><img src=/ptrace-1.png alt=ptrace-basics></p><h4 id=enforcement-with-ptrace>Enforcement with ptrace</h4><p>Now, if we can use ptrace to inspect and change the process state, it should be possible to use it to define what an application can and cannot do. Further, since ptrace can do all this in the userspace itself, we can use it to create a sandbox like environment and do enforcement only in the context of our workloads, reducing the coupling with underlying infrastructure.</p><p><img src=/ptrace-2.png alt=ptrace-enforcement></p><p>&mdash;WIP&mdash;</p><h3 id=show-me-some-code>SHOW ME SOME CODE!</h3><p>Fair enough.</p><p>We&rsquo;ll try creating a simple enforcer which will block the openat syscall made on a file specified by user. There are two ways by which a process can trace another, one of them is by executing the tracee as a child of the tracer. The other one involves the tracer attaching to the tracee while it is already executing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;path&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;syscall&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>EPERM</span> <span style=color:#66d9ef>uint64</span> = ^uint64(<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>EACCES</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>regs</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PtraceRegs</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Run: &#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stderr</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stdout</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Stdin</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdin</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>SysProcAttr</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SysProcAttr</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Ptrace</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>LookupEnv</span>(<span style=color:#e6db74>&#34;FILE_PATH&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;File path to match:&#34;</span>, <span style=color:#a6e22e>filePath</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Wait err: %v\n\n&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Process</span>.<span style=color:#a6e22e>Pid</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>exit</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>exit</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PtraceGetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>regs</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Orig_rax</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SYS_OPENAT</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>file</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>absPath</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>getString</span>(<span style=color:#a6e22e>pid</span>, uintptr(<span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Rsi</span>)))
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>filePath</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Orig_rax</span> = ^uint64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Rax</span> = <span style=color:#a6e22e>EPERM</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PtraceSetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>regs</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PtraceSyscall</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Wait4</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>exit</span> = !<span style=color:#a6e22e>exit</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>clen</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>b</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>i</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>b</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getString</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>buff</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PathMax</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>PtracePeekData</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>buff</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> string(<span style=color:#a6e22e>buff</span>[:<span style=color:#a6e22e>clen</span>(<span style=color:#a6e22e>buff</span>)])
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>absPath</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>p</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// if relative path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>IsAbs</span>(<span style=color:#a6e22e>p</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>getProcCwd</span>(<span style=color:#a6e22e>pid</span>), <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>Clean</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// getProcCwd gets the process CWD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getProcCwd</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fileName</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;/proc/self/cwd&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pid</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fileName</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;/proc/%d/cwd&#34;</span>, <span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Readlink</span>(<span style=color:#a6e22e>fileName</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></p></div><div class=prev-next></div></div></main><footer class=footer><span>&copy; 2023 Rudraksh Pareek</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>